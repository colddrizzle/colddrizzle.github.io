---
layout: post
title: 代码整洁之道读书感悟

tagline: "Supporting tagline"
category : 软件工程
tags : [clean_code]

---
{% include JB/setup %}

* toc
{:toc}

<hr />

想要命名得当，首先需要知道命名的背景，整体而言，名称所在的上下文，代码所用的浏览工具。

浏览工具虽然虽然不一样，但现代工具一些功能是通用的，比如类型判断、查找替换、颜色区分等等，只要不依赖于某款特IDE的特殊功能，我们都可以将其当做
代码中命名的背景。

名称的上下文以及浏览工具构成我们命名的背景，我们必须考虑这样的背景来进行合适的命名。


名称的问题域 解决域称谓

问题域与解决域又各有通用之称谓


比如解决域中的模式

比如问题域中的概称


## 命名

一个名称包含两个方面：形、意。三个原则指导命名的这两个方面。形是比较简单的，意则比较复杂。一个名称的意义往往是多重的，在问题域有其意义，在解决域又有其意义。
比如一个List，列表是解决域的意义，一组XXX物体则是问题域的意义。

即便明确了问题域与解决域，其意义往往还是多重的，这源于逻辑本身的复杂性。

### 形式上的原则要求

形式上容易拼读、易于区分、合适的长度，尽量避免编码。通常是源自自然语言的某个词汇。

容易拼读意味着容易阅读，容易在沟通中使用这个词汇，能拼读意味其意义是我们熟知的，尽管可能有多重意义，
但我们的大脑不需要从头开始将某串奇怪的符号与某个意义建立关联。

易于区分通常指的是两个变量名--尤其是长变量名--之间不要仅存在微小的差别。当然，最常见的是获得某个物体的单数与复数形式，比如getApple()与getApples()，
但是单复数的区分是根植于语言习惯的，对于英语母语或者熟悉英语的人来说，这种区分是足够醒目的。当然，进一步区分可以写作getOneApple()与getApples()。

易于区分还指的是有意义的区分，变量名a1、a2、a3之间的区分通常（并非绝对）不太明确，通常可以知道其意义，比如left、middle、right。


合适的长度通常是指变量名不要太长或太短，通常我们习惯于把变量名写的简短，甚至于单字母命名，但是面向对象编程的例子中你经常会发现一些过长的命名，看起来就像是一个句子。
太短的变量名其意义容易笼统，太长的变量名通常是没有利用程序本身的上下文信息，也就是冗余。如果实在需要在一个长名字和一个短名字之间取舍，长名字好于短名字。

编码是说名称存在内部结构，比如匈牙利编码，在现代IDE的编程环境下，这种编码方式过时了，不需要命名本身告知我们类型新型，毕竟我们不是使用txt来阅读代码。况且这种代码带来了
修改类型的麻烦（更一般的情况下是我们不应该修改类型，修改类型意味着我们在设计阶段有重大过失）。

命名编码尽量避免，但有些时候使用编码确实可以简化命名且语义明确，比如某一组确定有限个数的枚举常量命名。

接口与实现是一种常见的命名编码。有两种形式，IXXXX与XXXX，或者XXXX与XXXXImpl。作者推崇第二种形式，实际上是从使用者的角度出发的，使用这个代码的人不需要关心自己
拿到的是一个具体实现还是某个接口或代理。


### 意义上的原则要求

意义上直接、容易区分、合适的范畴。意义通常取自问题域或者解决域，具体取那一个要看这个名称距离哪一边更近一些。

合适的名词表达所有且不多余的含义，不需要注释，实际上需要注释意味着名词不恰当。当然有时候无法找出一个恰当的名词不是你词汇量
的问题，而是逻辑分解、程序设计上等大问题的一个局部反映。

直接意味着不要使用比喻、隐喻、非正式称谓，写代码是一种创作但不是文学创作。

意义上易于区分，ProductData与ProductInfo就不是太明显的区分，或者应该直接叫Product。

不容易区分通常是因为附带了无意义的词汇。作者这里讲table一词永远不应该出现在表名中，但我认为是不恰当的，现实总是复杂的。表这种结构
通常可以用数组等简单的数据结构来模拟，当这种模拟发生时，给变量名带一个table则会明确的多。

易于区分不仅仅值得是程序之内容易区分，但要跟以往经验互相区分，一个字符串变量的英文表达缩写后变为URL，
但指的并不是Uniform Resource Locator，这就不是一个合适的命名。

合适的范畴是意义上的合适的大小。给张三这个变量起名叫人类显然范畴太大了。



### 具体应该怎么做呢

取名最难的地方在于良好的描述技巧和共有的文化背景。命名是为了沟通，沟通才是目的，遵循原则只是手段，因此以上的原则是通常意义上，没有绝对，毕竟现实是复杂的。

选择问题域含义或者解决域含义。2.2、2.14、2.15就在讨论这个问题。

添加语境信息，这里所谓语境指的是一组名称可以构成某个有意义的整体，使用整体名称并引用其部分要好于分散的使用各部分名称。

类名通常是名词或名词短语。

方法名通常是动词或动宾短语。

成员变量一般不需要加m前缀，实际上这是一种编码，但在python这种语言中，类的内部变量加_前缀，这是因为语言本身规定如此，这不是编程习惯。

使用单字母变量，一个局部作用域的循环变量叫i并没有什么问题，这符合我们的一般经验，叫counter并不会更加明确。

add与insert：add操作的双方是对等的，意味着满足交换律：a.add(b)与b.add(a)得到的结果是一样的，insert则是某种集合操作。遵循这样的规律是有用的，
但并非绝对的，你经常会在一些知名项目中看到向集合中添加item的操作命名为add，这也没什么问题，因为正如我们写的那样，这是“向集合中添加item”。


## 函数

### 原则性要求

形式上短小，意义上只做一件事。

短小意味着if、else、for、while下面最多一行代码，通常是一个函数调用。函数体最多不超过20行。

只做一件事值得是函数体内的代码都是直接服务于同一个目的，这个目的就是函数名所表述的目的。
所谓直接服务就是可以用“为了XXX，必须YYY”这样的句式表述，YYY就是直接服务于XXX，若是出现为了YYY，需要ZZZ，则ZZZ不是直接服务于XXX。

另一种理解只做一件事情的方式是，找出客体与动作。记住，函数总是一个动作，且这个动词是及物动词，必有其宾语也就是客体，客体不必是一个物体或数据，可以是一组相同类型的数据，
只要这组数据上进行的动作是相同的（函数名标识的动作），那么就可以认为是一件事情。

动作除了客体有些还有主体，实际上动作总是有主体，而不一定有客体。当某一个动作发生，总是可以找出谁进行了这个动作，但不一定找出对谁进行了这个动作。人话就是，动词分为及物动词与非及物动词。


后面会所提到，一组相同类型的数据作为参数可以认为是一个参数。因此，从语言表述上来讲，单参数函数就是对某一个或一组数据进行某个动作，而双参数函数就是对一个或一组数据进行某种程度、烈度上的某个动作。由此我们就可以理解为什么不应该存在三参数函数，
三参数函数几乎肯定没有满足只做一件事的原则，因为我们找不到这样一个一句话之内的语言表述：其只是单纯的描述了主体上进行的动作。

如果你在写函数体的时候，如果下意识地讲一些代码隔开形成所谓的区段，几乎可以肯定这个函数没有遵循只做一件事情的原则。

在面向对象之前，客体与主体都是作为参数传递进去,然而经常出现混淆，比如

```
fly("duck") //让鸭子飞

eat("duck") //鸭子进食还是吃掉鸭子？

```

面向对象发展之后，作为参数传入函数的总是函数动作的客体，主体则以点调用的方式：
```
duck.eat() //鸭子进食

eat("duck") //吃掉鸭子
```

函数体短小是强制性的规则，只做一件事则不那么强制，如果满足函数体短小，且两件事之间关系密切的话，写在一个函数中未尝不可，
这种密切关系通常是某种附带关系，这样阅读者不至于为了理解一个函数而去查看另一个函数。

### 具体应该怎么做呢

#### 每一个函数一个抽象层级

每个函数一个抽象层级，最终我们想要这样读程序：程序就像是一些列TO起头的段落，每一段都描述当前抽象层级，并引用位于下一个抽象层级的后续TO起头的段落。

#### 函数分类

函数，顾名思义，在数学上可以看做一种映射，有输入就有输出。然而计算机中的函数有些表面上看起来没有输出。
表面看起来没有输出的函数几乎总是修改了全局状态（进行系统调用也是一种修改全局状态）。

因此函数至少可以分为两类：一类修改全局状态看起来没有输出，另一类则不修改全局状态（在不涉及函数闭包的情况下，那也就是没有自己的内在状态），这类函数也就是函数式编程
推崇的无状态函数。

从函数的功能上区分，函数可以分为指令函数与询问函数。二者区分在于是查询还是修改删除。

#### 函数名称

对于单一事件的函数，函数名称总是好起的，注意函数命名时可以将参数纳入命名的一部分。不需要写writeName(name)，而只需要写write(name)。

有些不得已破坏单一事件的函数其名字最好用and、with标志出来。
 
#### 函数参数

函数参数越少越好，从测试的角度讲，参数越少的函数，越容易测试。

应该避免使用标志参数，这几乎相当于在大声宣布这个函数不止做一件事情。

参数中有一类是输出参数。一般情况下，函数通过返回值进行输出。出现输出参数的情况无非是：一、函数做了多件事情，比如返回值用于判断是否成功，输出参数用于输出结果；二、返回值不止一个，
懒的将其封装成一个对象，或者难以将其抽象到一个对象中（一般这时候也是由于函数做了多件事情）。

关于输出参数与返回值的取舍讨论：https://blog.csdn.net/u010000297/article/details/74785998

同类型的参数列表应该被当做是一个参数。

#### 错误处理

使用异常代替返回错误码。通常java中用一个枚举类型定义错误码，修改这个枚举类型，需要重新编译。而如果使用异常机制，从异常中派生出新异常，不需要重新编译和部署。
（其实这里我还不太理解为什么换成异常就能避免重新编译部署）

错误处理本身就是一件事，因此需要将try/catch代码块单独作为一个层级抽离出来，意味着try/catch后只跟随一两行代码。

C语言中可以使用longjmp模拟try/catch,参见https://blog.csdn.net/qq_19825249/article/details/109257796

#### 处理switch语句
switch语句天生要做N件事情，作者的原则是如果switch语句只做一件事，并且是用于创建多态对象而隐藏在某个继承关系中，在系统的其他部分看不到，就还能容忍。

当然并非所有的语言都那么容易创建继承关系与多态。我们可以放松一些这个规则：如果对某类事物的switch语句只出现在一处，那么switch语句就是可以容忍的。代码中可以出现
多个switch语句，只要他们分别是对毫不相关的事物进行switch。

#### 避免重复

除了循环结构中，正常的树形分支结构中不应该出现重复调用某个函数的现象。

#### 避免多重循环嵌套

https://www.cnblogs.com/zhenghongxin/p/8682715.html

还有一类方式是使用迭代器与函数工具，python中itertools与functools。

#### 结构化编程

Dijkstra认为的结构化编程规则：每个函数、函数中的每个代码块都应该只有一个入口、一个出口。
这意味着每个函数中只应又一个return语句，循环中不能有break、continue语句，且永远不能有goto语句。

作者认为这个规则只有在大函数中才会有帮助，小函数中出现多个return、break、continue没有坏处。


### 渐进的方法

作者在3.12节承认，几乎不可能一次就写出符合上面提出原则的函数，这个过程是一个逐渐打磨的过程。

总是先写出丑陋的代码（在一些经验、范式的指导下没那么丑陋），然后配套上测试，最后逐步优化改造成理想的函数。


## 注释

### 原则

注释的作用是弥补我们用代码表达意图的失败。注释是二等公民，应该首先尝试用写好代码，然后用注释给与补充。

注释相比于其注释的代码，朽坏的速度总是更快。当其朽坏，注释反而成为理解代码的阻力。朽坏是不可避免的，因此注释应该少些。

就算你注释写的再通达简洁，也不能替代糟糕的代码。

注释的原则：必要、通达、简洁。必要指的是不要废话，重复一遍代码做的事情毫无意义，代码实在无法表达的东西，用注释来补充。通达指的是注释的语义要明确到位，一知半解的注释还不如没有。简洁就是注释不要太长。

### 应该怎么做呢


### 不应该怎么做呢

## 格式

格式很重要，但是鉴于现在都有自动化格式模板，这一块跳过。

### 垂直格式

### 横向格式

注意，作者这里否定了水平对齐的作用。

多参数函数的参数垂直排列还是有用的。

## 对象与数据结构

私有变量意味着自由的修改，包括其类型的修改，而类型是很容易传播的一个变量属性，如果能将其所有修改限制在类之内，这个变量就可以成为私有变量。





