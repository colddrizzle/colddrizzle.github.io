---
layout: post
title: Computer Networking-A Top-Down Approach

tagline: "Supporting tagline"
category : network
tags : [book notes, network]

---
{% include JB/setup %}

* toc
{:toc}

<hr />


# 3 运输层

# 4 网络层

路由与转发的严格区分：转发指的是分组从路由器的入段口到出端口的选择与传送行为。
而路由涉及一个网络中的所有路由器，它们经选路协议共同交互，以决定分组从源到目的地节点所采取的路径。

## 4.1 概述	

### 4.1.1 选路与转发

转发、选路与建立连接是网络层的重要功能。当然数据报网络不需要建立连接。然而虚电路网络是需要的。

本节提到了分组交换机的概念，分组交换机包括我们通常意义上的二层交换机和路由器。
由此可见，路由器也是一种交换机。因此所谓的三层交换机与路由器直接的区别可能没有那么大。

## 4.2 虚电路和数据报网络

虚电路与数据报分别相当于网络层的面向连接与无连接服务。

无论虚电路还是数据报网络，基本的网络拓扑都是一样：一些外围的端系统连接着中间的路由网络。
源与目的之间的一条路径可以看做一段一段构成，每一段的两端是端系统或者路由器，中间不包括路由器，
可以认为每一段就是一段单纯的数据线。

有了以上的认识我们就很容易理解虚电路与数据报网络了。

### 4.2.1 虚电路网络

所谓虚电路就是在路径的每一段都有一个VC号。一条虚电路路径的每一段的VC号不相关。这样路由器的转发表
的大小等于同时经过该路由器的虚电路的数目。转发表的每一项将该路由的一个入接口与出接口相关联。

你也许想知道为什么一个分组沿着其路由在每条链路上不能保持相同的VC号。第一，这减少了分组首部中VC号字段的长度。
若是一个连接使用一个共同的VC号，意味着不同的连接必须使用不同的VC号，那么首部字段的长度取决于整个网络中的连接数目。
若是使用分段不同的VC号，那么VC字段的长度取决于路由器的最大端口数目，显然大大减少了VC号字段的长度。第二，简化了虚电路的建立。
若是使用连接各段共同的独立的VC号，考虑到一个连接可能在路由器网络中的任意两个端口之间建立，为了保证连接之间VC号不重复，一个新
的连接建立要与全网路由器进行通信来约定新的VC号。

那么问题来了，既然路由器中没有目的地址的路由项，一个虚电路连接是怎么建立起来的呢？这个问题书中未涉及，仅做有兴趣去查找思考吧。

### 4.2.2 数据报网络

所谓的数据报网络每一段上并没有单独的标记，或者从转发表来理解，转发表的仅仅关心目的地址要在本路由器的哪个接口送出去
以及下一条的地址。但是无论一个连接存不存在，发往既定目的地址的路由表项都存在。

一个路由表的一个出口可能最终对应多个地址，通常是一片连续的地址，因此路由表项往往是一个连续的目的地址范围对应一个出接口。
使用这种风格的转发表，路由器使用分组的目的地址前缀与表项进行匹配，也就是说路由不关心该分组从哪个端口哪个地址来的，只关心它去哪儿。当一个目的地址匹配多项的时候，使用最长前缀匹配规则。

最长匹配原则要求每个输出链路接口应当负责连续的目的地址。书上是这么讲，但我认为这个要求是毫无道理的。
最长匹配原则失效除非最长匹配能匹配到两个同样长的表项目而它们的链路出口不一样，显然这是不可能的。因此跟是否连续地址没有关系。

地址是否连续影响的是转发表的大小，地址连续块越小，转发表也就会越大。据说现代骨干网路由器的表项多达几百万。

与虚电路实时的转发表更新不同，数据报网络转发表通常是1-5分钟定时更新一次。因为转发表随时可能修改。一个TCP连接的上一个分组与下一个分组可能走不同的路由，最终导致无序到达。


网络层虚电路与网络层数据报的差异主要在于路由器必须为连接中的虚电路维持状态信息。

网络层虚电路与传输层TCP连接的差异：TCP连接的状态信息仅保存在端系统上。而虚电路的连接状态不仅仅保存在两端，也保存在路径上的所有路由器上。

## 4.3 路由器工作原理
需要注意这里的输入与输出端口与外观上RJ45接口是不一样的，一个RJ45接口里面显然既有输入又有输出。

## 4.4 网际协议：因特网中的转发与编制

网络层三大组件：IP协议，选路组件（转发表与选路协议），互联网控制报文协议（ICMP）。

### 4.4.1 数据报格式
IP数据报因为首部包含“选项”字段，因此首部长度是可变的，为此，首部中有4个比特来说明首部长度，这里的单位是4个字节，通常无选项字段的IP数据报的首部长度为20字节，也就是0101。

数据报长度字段是包含首部长度的，共16比特，一位置而理论上IP数据报的最大长度为65535字节，但因为链路层MTU的存在，很少有超过1500字节的数据报。
再扣去20字节的IP头部，因为我们运输层发送数据的时候分组大小不应该超过1480字节，而这还没算传输层协议头部长度，上一章我们知道TCP报文首部长度可变，通常为20字节，选项长度通常只包含12字节的时间戳，这意味着我们使用TCP的时候单次数据一般不应该超过1448字节的长度。
而UDP首部长度固定为8字节，故而UDP单包数据不应超过1472字节。

	MTU的意义：第一是分片影响传输效率，第二是UDP编程中若是被分片，因为分片的无序到达加上UDP的不可控性，导致程序失败。
	MTU的探测：可以通过`ping -f -l test_length ip_address`来探测到某个IP路径上的最大MTU，但这种方法存在不可控性，因为ping通过ICMP报文来实现，
	而ICMP是IP报文承载的，IP报文传输的路由随时会更改，尽管如此，用来测主机到默认路由这种短程的MTU还是没有问题的。


需要注意的是标识、标志与片偏移三个与IP分片相关有关的额字段。

另外提到了IPv6（RFC3513）不允许在路由器上分片。

#### IP数据报分片

IP数据报之所以要分片跟IP协议或者网络层限制无关，而是受限于链路层最大帧的大小，以太网帧最大承载不超过1500字节数据，这里指的是纯数据，不包括以太网帧头部。

分片是由路由器进行的，但是分片的组装是由端系统进行的。
16比特标识位用来表示一个原始的IP分组的序号，分片后用来确认几个片属于同一个IP分组。
标志占3位，但只有2位有意义。标志字段中的最低位记为MF(More Fragment)。MF=1即表示后面“还有分片”的数据报。MF=0表示这已是若干数据报片中的最后一个。标志字段中间的一位记为DF(Don’t Fragment)，意思是“不能分片”。只有当DF=0时才允许分片。13比特偏移用来表示片在原来数据报的位置，以8字节为单位。

注意IP数据报头部里的三种长度三种单位。

### 4.4.2 IPv4编址
本节首先提到主机也好路由器也好与一条链路直接是通过接口相连的，因此，技术上来说一个IP地址是与一个接口相关联的，而不是与包括该接口的主机或路由器相关联。注意这种关联未必是一对一关联，网络设备篇我们会再谈到这个关联问题。




## 4.5 路由算法

## 4.6 因特网中的选路

## 4.7 广播和多播选路

# 5 链路层和局域网

链路层章5.4之前的内容我们不关心。
## 5.4 链路层编址

## 5.5 以太网