---
layout: post
title: IP Address Space

tagline: "Supporting tagline"
category : network
tags : [ip, ip address]

---
{% include JB/setup %}

* toc
{:toc}

<hr />

本文非系统性的阐述IP编址相关的内容，而是记录一些相关问题。

## IP是什么
狭义上讲IP是第三层网络层的设备地址。而广义上讲，IP是Internet Protocol，Internet协议（Internet Protocol）是一个协议簇的总称。
本篇指的是狭义意义。

<hr />
问题：哪些设备？
主机网卡，路由器，三层交换机。

问题：设备与IP地址之间是怎么对应的？
一个网卡端口可以有多个IP地址吗？
可以。多个网卡也可以拥有一个IP

问题：路由器每个端口都有一个IP地址吗？
一般是这样的，但通常是[为了避免配置错误][0]，实际上高级的路由器可以自由配置端口IP。
同网卡一样，路由器每个端口也可以有多个IP（虚拟子接口）。

问题：三层交换机的每个端口都有一个IP吗？
三层交换机与二层交换机的区别在网路设备篇会再讲。

注意：这里要特别提一下二层交换机的所谓管理IP。
三层交换机以及路由器拥有一个管理IP并不令人意外。通常这个管理IP是远程登录用来配置路由器的。但是还有一个原因，某些路由协议如OSPF需要一个
ID来唯一的标识一台路由器，也就是Router ID，这个Router ID通常与管理IP是一回事。通常管理IP或Router ID配置在路由器的Loopback虚拟接口上，这个
虚拟接口与路由器工作接口共用物理端口（一个端口有多个IP）。那么路由器或者三层交换机的管理IP是否是其中一个接口的IP呢？想来应该是这样的，因为没有多余链路连接到该设备，必然是接口IP中的一个，此处存疑。

有关管理IP可以参考[这里][1]。有关RouterID可以参考华为企业级路由器[HUAWEI NetEngine 8000 M1A, M6 产品文档][2]中"配置->IP路由"一节。
<hr/>

## IPv4
### IPv4地址的构成
IPv4是一个32bit的有序字节，通常表示成点分十进制的形式。

### IP地址的管理与分配
IP地址作为互联网基础设施的一部分，自然是由一个专门组织来管理分配的，否则大家自由使用，无法避免冲突，也就不能全球互联了。

IP地址的统一管理由ICANA（互联网名称与数字地址分配机构）管理，并且是按地域分级管理，比如亚太地区由APNIC管理。
这些机构不仅管理IP分配，还管理自治域系统号以及根域名服务器。

IPv4的地址由32位组成，大约40多亿，但随着设备增多，IPv4已经用尽了。但这个“用尽”指的是ICANA以及其次级区域性机构已经分配完了所有的
IPv4地址块，但是各个企业、ISP手中尚存在许多未实际使用的IPv4地址。具体参考[这里][3]和[这里][4]和[这里][5]。

IPv4地址作为一种不可再生资源，自然成为各大企业争抢的目标。可以根据IPIP.net出具的行业包括查看各云厂商拥有的IP地址数量，比如[19年行业报告][6]。

### IP地址的划分
我们知道因特网起源于美军ARPANET项目，在最初的设想中，使用的分类地址设计（RFC791-3.2节，1981），随后随着ARPANET军转民以及互联网的扩大和发展，很快发现分类地址的不灵活之处，因此发展了SUBNET技术（RFC917,1984）。随着网络扩大，IPv4地址开始紧缺，原来的分类地址设计在地址分配上存在的巨大浪费，因此又发展出了CIDR技术（RFC1519，1993）。如今的分类地址已不再实际使用，通常所说的A类地址、B地址仅仅指的是CIDR中的特殊情况的代称。SUBNET技术也大相径庭，仅仅是名称保存了下来。

#### 分类地址
分类地址最早描述在RFC790中，1990年RFC1166和1992年RFC1375更新了分类地址描述。分类地址的基本设计思想是分类，而不是分层。乍看之下，A类地址很大，C类地址很小，似乎是一个A类地址可以拆分成许多个C类地址，然而这时不可能的。分类地址的前几个比特是固定的。具体如下：

```
A:0...
B:10...
C:110...
D:1110...
E:11110...
```
因此在分类地址时代，虽然一个IP也可以拆分成网络号与主机号，但是并不需要网络掩码来计算网络号，因为网络号是固定的那几种。

网络号是固定的，因此一个确定类网络中的主机数也是确定的。RFC1166第6页规定一个地址的网络号部分若是全是0，代表this，也就是当前网络，
若是主机号部分全是1，代表all，这就是网络号指定的网络中的所有主机，作为该网络的广播地址。若主机号部分全是0但是网络号部分正常表示，则该IP与这个IP所在的网络地址相同，因而不予适用（这是[确信的][0]，但是我没有找到RFC根据）。因此，通常来讲计算一个分类网络中的主机数要减去2，因为主机部分全0与全1的IP有特殊用途。

这种分类地址在实践中很快被发现不够灵活。比如一个C类地址包含254个主机地址，而一个B类地址包含65534个主机地址。IP地址分配中通常给一个组织机构分配若干个网络段，然而一个组织机构往往是分散多处的。比如某机构在全国拥有7个办事处，每个办事处拥有1-20台主机，各个办事处互相远离。给这个机构分配7个C类地址的话，每个办事处将有大量的浪费。若是分配一个C类地址的话，则网络拓扑不允许除非该机构自己搭建基础设施连接各办事处。

因此RFC917提出来子网划分技术，详细参考RFC。其基本思路是从主机地址部分的分出几个比特构成子网号，子网划分由各机构自行进行。
比如一个A类地址划分子网后，结构如下：
```
-----------------------------------
|   网络号   |  子网号  |  主机号 |  
-----------------------------------
```

外部网络不知道子网划分情况（注意这个时候只有分类地址，不存在分类地址以外的网络地址，因此源主机不知道目的主机是否划分子网）。唯一一处需要知道掩码的地方是源主机，源主机需要据此判断是直接发送到网管还是发送到目的主机，因此源主机路由算法需要做一点修改，详细参见RFC917。

子网划分是平均划分。一般而言，子网划分最少需要从主机号部分拿出两个比特（只拿出一个比特则得到的主机号只有全0与全1两种情况，当然RFC3021有一些特殊规定，下面点对点连接会讲）。

RFC917中明确指出反对子网嵌套，也就是不允许子网再划分子网。但这是分类地址时代的规定了。

主机通过ICMP协议地址掩码请求报文从邻接路由器中获取自己的子网掩码。对于家用路由器来说，这个过程通常包含在DHCP协议中，具体参见协议篇。

但是子网划分并没有完全解决IP浪费的问题，问题就在于子网划分是平均分的，而实际中各办事处的主机数差异巨大，平均分法必须保证能容纳各办事处中最大的主机数，那么主机数少的办事处就浪费了大量IP。为了解决这一问题，1993年RFC1519提出了CIDR(Classless Inter-Domain Routing)，RFC1878提出了VLSM（Variable Length Subnet Mask）。2006年RFC4632更新了CIDR技术。

关于本节更多更详尽的内容可以参考[][]和[][]。

##### 点对点连接
所谓点对点连接，指的是两个网络仅通过两边各一个路由端口相连。上面我们提到过，这种情况两个端口必须配置在同一个网段内。但如果划分子网的时候留出2位主机位，则形成4个IP地址。但其实这种情况下网络地址与广播地址并没有实际意义，实际上也就是浪费了两个地址。IPv4地址紧缺的情况下，可以想见全球网络中会有很多这种情况，从而浪费大量的IP，为此发展出了两种技术来节约IP：[IP Unnumbered][9]与[31-bit-prefixes][10]。关于31-bit-prefixes，在RFC3021中有详尽描述。

<hr />

关于分类地址更多可以参考[RFC1166][7]和[RFC1375][8]。

#### CIDR与VLSM

但其实CIDR并不仅仅是为了解决IP地址浪费，同时也是为了解决路由表增大。为了理解这一点

CIDR与VLSM的区别



#### 子网划分从分类地址到CIDR的一些变化

路由方式
子网掩码从无到有。
子网掩码概念内涵变化。平均分到任意分。
子网概念从绝对变成相对。
是否允许子网嵌套

#### 子网掩码的作用

子网掩码就是用来标记该IP所在的网络号的。根据CIDR，任意一个IP必然是术语某个网段的，且一个IP只能属于一个网段。因此子网掩码就是用来标记该IP所在的网络号的。也就是说，任意一个IP必然有且只有一个子网掩码。

子网掩码的唯一作用就是计算IP地址中的网络号部分，确定了网络号才能确定路由。因此，子网掩码的主要作用是用于路由。为了清楚的理解这一点，让我们考虑两个场景，本地与远程发送IP包？？？？

实际上，每一个IP地址必然是伴随着一个网络掩码的，但是为什么我们平时使用IP地址却不需要指定它呢？我想有两个原因，第一个是
网络掩码使用来进行路由的，在我们不关心如何路由到该IP的时候我们不需要关系路由。第二个是不存在IP相同但是有网络掩码不同的情况（因为
应用端从不会也不应该知道目的IP的网段，因而转发IP包的时候，若是有相同IP不同网络掩码的状况则IP包不能确定唯一地址），也就是单凭IP地址就可以确定唯一一台设备。

	
### 特殊IP地址

RFC
以及明确规定路由器不会进行转发的目的IP地址

### 为了节省IP所做的努力

如果不是先后采用了诸多新技术，如 1993 年的 VLSM 与 CIDR (RFC 1519)、1994 年的 NAT（名称地址转换）(RFC 1631) 以及 1996 年的“私有地址”(RFC 1918)，IPv4 的 32 位地址空间现在可能已经耗尽。

## IPv6

### IPv6的构成与表示

### 地址划分

### 特殊IP地址

IPv6有子网掩码吗

#### 广播地址
四类广播地址
http://www.mamicode.com/info-detail-136888.html

## IPv6与IPv4的兼容

dns查询的时候，dns服务器怎么知道要返回哪个地址，还是两个都返回？



## IP Mac与地理位置
IP 域名 mac地址 地理位置之间的互查

ipip.net上的接口和工具



[0]:https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipaddr_ipv4/configuration/xe-3s/asr903/ipv4-xe-3s-asr903-book/config-ipv4-addr.html#GUID-3A8E77FF-BBE0-4C16-AAEF-ED7FEC17E3FB
[1]:https://zhidao.baidu.com/question/550715016.html
[2]:https://support.huawei.com/enterprise/zh/routers/netengine-8000-m-pid-250516989
[3]:https://blog.51cto.com/wangchunhai/655860
[4]:https://www.baojiabao.com/tech/tc201911261850465881.html
[5]:https://cloud.tencent.com/developer/news/483837
[6]:https://cdn.ipip.net/download/1H_2019_CSP_Report_CN.pdf
[7]:https://tools.ietf.org/html/rfc1166
[8]:https://tools.ietf.org/html/rfc1375
[9]:https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipaddr_ipv4/configuration/xe-3s/asr903/ipv4-xe-3s-asr903-book/config-ipv4-addr.html#GUID-D707D24B-71E9-44C7-B8E2-692491D6AF38
[10]:https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipaddr_ipv4/configuration/xe-3s/asr903/ipv4-xe-3s-asr903-book/config-ipv4-addr.html#GUID-A6AA4621-6662-4CC5-BE57-15CCD38C0FA2