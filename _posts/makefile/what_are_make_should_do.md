--略谈gnu makefile--

ucos_on_mac 项目的小小的makefile就引出了一堆问题，促使我思考为什么make这么难用，make本身应该做什么，gnu make的最佳实践是什么，以及理想的make工具应该是什么样。

# 一、 make本身应该聚焦做的事情

1. 精确高效圈定一堆源文件
2. 精确高效圈定其依赖头文件
3. 编译成目标文件到指定文件夹
4. 精确高效圈定目标文件
5. 精确高效圈定头文件
6. 链接成可执行文件输出到指定目录
7. 清理

**智能性：**
8. 更新依赖检查。
9. 同名编译（foo.c-->foo.o）

# 二、make为什么难用
本来是很明确的事情，可是gnu make提供了一堆目的不明确的工具，使用这些工具，配合shell命令，拼凑成构造逻辑，基础就是术业无专供。

## 原因一
  make里没有把文件路径看着文件目录+文件的结构，而是单纯看做字符串。因此文件圈定变成了字符串替换等处理。

## 原因二
工具之间难以配合。VPATH 自动变量 静态变量 模式规则放在一起，有的互相起作用，有的不起作用。

比如模式规则的目标严格依赖于其他规则的依赖，而模式规则的依赖的寻找一般情况下又依赖于VPATH寻找路径。
模式规则不能作为默认目标。VPATH下文件只需要文件名，而wildcard下指定的文件往往是相对路径，二者没有转化工具
或者就不需要转化。规则的依赖目标是相对路径的情况下，如果这些相对路径是另一个规则的输出，但是这些输出被转移到其他
目录，二者就没法用同一个变量表示，但实际上二者是同一批文件。再一个，VPATH仅仅是范围，他并没有选定文件，与其他
指定文件的方式也没有交互，想要完成取VPATH下所有的头文件这种操作，必须另行他法，难以使用。模式规则难以被多个目标依赖。
从VPATH也好，shell命令圈定的文件里面也好，合并两堆文件或是排除某些文件是不可能的或是无聊无意义且困难的字符串操作。
VPATH对于编译时头文件查找不管用,只对依赖文件查找有用。VPATH对于wildcard的展开范围不管用，需要在后面立刻指定。

***STUPID!!!***

我只是依赖于另一个目标的输出，并不真的关心另一个目标的输出到底移动到了那个文件夹，不管你怎么移动，我都是
依赖这些输出，但是makefile的做法因为以上的种种原因，很难做到这一点。

## 原因三
语法怪异，可读性差。自动依赖追踪写出来简直就是火星文。

## 原因四
潜规则过多，本意是方便，其实是障碍。


# 三、目前情况下编写makefile的最佳实践：

* 依赖只引用文件名，依靠VPATH去寻找具体文件。
* 依靠字符串编辑去给这些文件套上路径然后用在编译或shell命令中。

保证上面两条，就可以方便组织路径，方便使用模式规则。方便移动文件。其实文件名就是下面我们要提的文件集的
概念，只不过makefile工具不完整，需要shell命令来完成这些操作。


# 四、理想的make工具
* 严格的目标依赖。若目标有输出，那么无论输出位置怎么挪动，依赖他的目标都不必关心。
* 只要不破坏编译中的必要依赖顺序，可以任意组合输出目标到任意文件夹中。
* 必要而不泛滥的默认规则 默认提供常见的类似java的对称编译，
有一个com.aaa.bbb.cc.java，就有一个com.aaa.bbb.cc.class组织结构。
* 方便的方法圈定文件集，文件集的交并补操作。
* 文件集是抽象，不关心文件存储位置的变动。
* 文件集的取文件名，取路径，排除某类文件，移动位置等等操作。
