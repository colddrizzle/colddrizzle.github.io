---
layout: post
title: 编译链接调试疑问
description: ""
category: compile
tags: [compile, link, debug,questions]
---
{% include JB/setup %}

由于要跟一下cpython的代码运行了解下python实现原理。需要编译、调试cpython源代码。
期间对编译、测试的工具做了一些了解。

问题1、编译链接器的基本工作

		问题1、编译期间如何组织源文件、需不需要头文件、需要哪些头文件
			大略来讲，编译的事情就是把源文件逐文件逐文件地从人可阅读的文本格式转化为机器可执行的内存格式。这个转化过程实际
			上处理两件事情。
			第一，将所有的符号识别归类，也就是识别出符号a与符号b引用的是同一块内存，识别出函数调用并分配栈空间以传递参数。
			那么因为要给符号分配空间，给被调用函数分配传参空间，因此必须要知道符号与函数的定义才能知道数据宽度，确定size。
			此时不允许出现未定义的函数，因此链接期间需要头文件。所有的对全局符号和本文件未定义的函数调用都暂时写成某个虚拟地址的调用，该地址只是起到占位的作用，编译器将该地址与所代表的的符号或是函数一一关联起来写在目标文件中，这就是符号表。符号表是一个连接用的对接口径。
			所以你也可以理解c语言中的extern外部变量的意义了。表示不要在该文件生成的目标文件中给他分配存储空间，先给他一个虚拟地址，链接的时候再去关联真实的地址。

			第二，将上层语言逻辑翻译为机器指令 
		问题2、链接器需不需要头文件
			上一步编译的时候其实只需要知道声明就可以了，但是连接的时候需要将多个目标文件合并成同一个目标文件。那么不允许出现一个虚拟地址在其他目标文件中找不到其真实的地址。链接期间不需要头文件。

问题2、调试器的大致工作原理

	回想一下编译型语言在IDE中的调试过程，首先使用编译器生成调试版本的可执行文件，然后在源文件上打一个断点，然后使用调试器运行该可执行文件。执行到断点处暂停执行，并在编辑器里面显示当前上下文堆栈情况（内存值、全局\局部变量值）。并且调试过程可以随时打断电。
	所以调试器能够监视被调试程序的执行并在想要的地方暂停程序的执行，乍一看好像是操作系统层面才能做到的事情，那么调试器是如何做到的呢？ 再者，调试器是如何将可执行程序里面的机器码与源文件与断点关联起来的呢？
	实际上，CPU确实提供了解决方案。intel系列的cpu有一个特殊的指令--int 3（https://www.cnblogs.com/alantu2018/p/8997173.html 非常好的文章，建议细读）。该指令触发一个中断，将程序停止。玄妙之处在于该指令的机器码只有一个字节0xCC。这意味着可以将代码块中任意一条指令的第一个字节替换成int 3.于是动态中断实际上是通过动态修改程序的代码块来实现的。那么可想而知，动态修改代码的东西就是调试器。而另一方面，编译时通过指定输出调试信息，将指令序列与源代码的位置（文件位置+行数）一一对应起来。调试器只需要查找这个调试信息就好了，详细参见（https://blog.csdn.net/zhanglidn013/article/details/71405318）。一般而言，这个调试信息在gdb下是编译在可执行文件中，但是也可以生成独立的调试文件（https://blog.csdn.net/kibaamor/article/details/43230481），等到调试的时候再讲该文件指示给调试器。windows下VS IDE默认的调试文件就是独立的pdb文件。


	对于解释执行如python来说，解释器当然全权控制程序的运行。程序本身不需要编译，自然没有源代码与机器码的对应问题。以上的问题对于解释执行来说都不是问题。那么为什么要单独的pdb呢，而不是python.exe本身就可以调试呢？


问题4、交叉编译\混合编译
	交叉编译：在一个平台上生成另一个平台下的机器码可执行文件。
	混合编译：使用多种语言开发同一个工程。当然多种语言最后生成的都是同一个平台下的机器码，难点在于编译时处理参数传递。

问题5、dump工具、线程调试


cpython是一个特殊的项目，本身是C语言编写的，但是生成的可执行文件是Python，而python本身又是python语言的解释器。

于是就测试、调试来讲，就存在不同的层面。

测试\调试：
	测试：直接运行最终可执行文件测试不同输入的输出是否符合要求。
	调试：使用调试软件来监视可执行文件的运行。考察某个输入如何在内部逻辑中被处理。

	1.C语言测试代码，测试解释器功能性
		测试代码由gcc编译 gdb调试。
	2.python语言测试代码 测试语言特性。
		测试代码由pdb解释执行。

	3.python语言测试代码 测试解释器功能性。
		测试代码由gcc编译 gdb调试。其实此时的python测试代码就可以看做我们要调试的程序的输入，而不是我们要调试的程序本身。
	由于涉及到上下层不同的语言，所以初看起来有点怪异，实际上没什么特别的。唯一需要注意的是，此时我们上层是调试的python语言，
	但在C语言层面，c的编译、调试对python语言语法是不感知的。就像网络中传输层协议不感知应用层协议一样。这样的话，在调试中一些上层的python对象就变成了c语言层面的复杂的结构体，可读性变差。幸好在我们的例子中，cpython对于vscode提供了插件，可以在c语言层面调试查看调试内容所对应的上层概念。


https://zhuanlan.zhihu.com/p/34003929
